"use strict";(self.webpackChunk_JUPYTERLAB_CORE_OUTPUT=self.webpackChunk_JUPYTERLAB_CORE_OUTPUT||[]).push([[4634],{84634:(e,t,o)=>{o.r(t),o.d(t,{Annotation:()=>j,AnnotationModel:()=>ne,Annotations:()=>L,CommandIDs:()=>s.TQ,ControlPanelHeader:()=>B,ControlPanelModel:()=>H,FloatingAnnotation:()=>w,FormDialog:()=>n.D,JupyterCadPanel:()=>T,JupyterCadWidget:()=>A,LeftPanelWidget:()=>U,LuminoSchemaForm:()=>R.d,MainView:()=>M,Message:()=>b,ObjectProperties:()=>$,ObjectPropertiesForm:()=>R.z,ObjectTree:()=>G,PanZoom:()=>K.I,ReactAnnotations:()=>k,RightPanelWidget:()=>Q,Separator:()=>oe,SketcherDialog:()=>Y.y,SketcherModel:()=>q._,SketcherReactWidget:()=>X.M,TOOLBAR_SEPARATOR_CLASS:()=>te,ToolbarSwitch:()=>Z.OR,ToolbarWidget:()=>se,UsersItem:()=>ee,addCommands:()=>s.nA,axesIcon:()=>g.Gw,boxIcon:()=>g.yc,coneIcon:()=>g.Ab,createHeader:()=>D,cutIcon:()=>g.xi,cylinderIcon:()=>g.AB,debounce:()=>g.Ds,distance:()=>Z.TE,drawCircle:()=>Z.xE,drawLine:()=>Z.pS,drawPoint:()=>Z.Qd,explodedViewIcon:()=>g.$r,extrusionIcon:()=>g.HZ,focusInputField:()=>g.Dd,getCSSVariableColor:()=>g.pj,getElementFromProperty:()=>g.on,intersectionIcon:()=>g.Y4,itemFromName:()=>g.ro,jcLightIcon:()=>g.S5,minimizeIcon:()=>g.YV,nearest:()=>g.Rq,newName:()=>s.dO,removeStyleFromProperty:()=>g.ef,requestAPI:()=>g.q7,setVisible:()=>s.yx,sphereIcon:()=>g.kT,throttle:()=>g.P2,torusIcon:()=>g.e_,unionIcon:()=>g.eR});var s=o(34614),n=o(59331),i=o(55176),a=o(1745),d=o(23190),r=o(86129),l=o(93119),c=o(12955),h=o(76012),m=o(51040),p=o(95727),u=o(12766),v=o(45494),_=o(42122),g=o(83347);const b=e=>{var t,o,s;const{self:n,message:i,user:a}=e,d=null!==(t=null==a?void 0:a.color)&&void 0!==t?t:"black",r=null!==(o=null==a?void 0:a.display_name)&&void 0!==o?o:"",c=null!==(s=null==a?void 0:a.initials)&&void 0!==s?s:"";return l.createElement("div",{className:"jcad-Annotation-Message",style:{flexFlow:n?"row":"row-reverse"}},l.createElement("div",{className:"jcad-Annotation-User-Icon",style:{backgroundColor:d},title:r},l.createElement("span",{style:{width:24,textAlign:"center"}},c)),l.createElement("div",{className:"jcad-Annotation-Message-Content"},l.createElement("p",{style:{padding:7,margin:0}},i)))},j=e=>{const{itemId:t,model:o}=e,s=o.getAnnotation(t),n=l.useMemo((()=>{var e;return null!==(e=null==s?void 0:s.contents)&&void 0!==e?e:[]}),[s]),[i,a]=l.useState("");if(!s)return l.createElement("div",null);const d=()=>{o.addContent(t,i),a("")};return l.createElement("div",{className:"jcad-Annotation"},e.children,l.createElement("div",{style:{paddingBottom:10,maxHeight:400,overflow:"auto"}},n.map((e=>{var t,s;return l.createElement(b,{user:e.user,message:e.value,self:(null===(t=o.user)||void 0===t?void 0:t.username)===(null===(s=e.user)||void 0===s?void 0:s.username)})}))),l.createElement("div",{className:"jcad-Annotation-Message"},l.createElement("textarea",{rows:3,placeholder:"Ctrl+Enter to submit",value:i,onChange:e=>a(e.currentTarget.value),onKeyDown:e=>{e.ctrlKey&&"Enter"===e.key&&d()}}),l.createElement("div",{onClick:d},l.createElement(_.caretRightIcon.react,{className:"jcad-Annotation-Submit"}))))},w=e=>{const{itemId:t,model:o}=e,[s,n]=l.useState(e.open),i=e=>{var s;return e?n(!0):(null===(s=o.getAnnotation(t))||void 0===s?void 0:s.contents.length)?void n(!1):o.removeAnnotation(t)};return l.createElement("div",null,l.createElement("div",{className:"jcad-Annotation-Handler",onClick:()=>i(!s)}),l.createElement("div",{className:"jcad-FloatingAnnotation",style:{visibility:s?"visible":"hidden"}},l.createElement(j,{model:o,itemId:t},l.createElement("div",{className:"jcad-Annotation-Topbar"},l.createElement("div",{onClick:async()=>{var e;if(!(null===(e=o.getAnnotation(t))||void 0===e?void 0:e.contents.length))return o.removeAnnotation(t);(await(0,v.showDialog)({title:"Delete Annotation",body:"Are you sure you want to delete this annotation?",buttons:[v.Dialog.cancelButton(),v.Dialog.okButton({label:"Delete"})]})).button.accept&&o.removeAnnotation(t)}},l.createElement(_.closeIcon.react,{className:"jcad-Annotation-TopBarIcon"})),l.createElement("div",{onClick:()=>{i(!1)}},l.createElement(g.YV.react,{className:"jcad-Annotation-TopBarIcon"}))))))};c.u9r.prototype.computeBoundsTree=h.Xy,c.u9r.prototype.disposeBoundsTree=h.sn,c.Kj0.prototype.raycast=h.uL;const y="--jp-inverse-layout-color4",f="--jp-inverse-layout-color2",C="--jp-brand-color0",x=new c.Ilk((0,g.pj)(y)),S=new c.Ilk((0,g.pj)(f)),O=new c.Ilk((0,g.pj)(C));class M extends l.Component{constructor(e){super(e),this.addContextMenu=()=>{const e=new a.CommandRegistry;e.addCommand("add-annotation",{execute:()=>{var e;if(!this._pointer3D)return;const t=(new c.Pa4).copy(this._pointer3D.mesh.position);if(this._explodedView.enabled){const e=this._computeExplodedState(this._pointer3D.mesh);t.add(e.vector.multiplyScalar(-e.distance))}null===(e=this._model.annotationModel)||void 0===e||e.addAnnotation((0,u.Z)(),{position:[t.x,t.y,t.z],label:"New annotation",contents:[],parent:this._pointer3D.parent.name})},label:"Add annotation",isEnabled:()=>!!this._pointer3D}),this._contextMenu=new d.ContextMenu({commands:e}),this._contextMenu.addItem({command:"add-annotation",selector:"canvas",rank:1})},this.sceneSetup=()=>{if(null!==this.divRef.current){x.set((0,g.pj)(y)),S.set((0,g.pj)(f)),O.set((0,g.pj)(C)),this._camera=new c.cPb(90,2,.1,1e3),this._camera.position.set(8,8,8),this._camera.up.set(0,0,1),this._scene=new c.xsS,this._scene.add(new c.Mig(16777215,.5)),this._cameraLight=new c.cek(16777215,1),this._camera.add(this._cameraLight),this._scene.add(this._camera),this._renderer=new c.CP7({alpha:!0,antialias:!0}),this._renderer.setClearColor(0,0),this._renderer.setSize(500,500,!1),this.divRef.current.appendChild(this._renderer.domElement),this._syncPointer=(0,g.P2)(((e,t)=>{e&&t?this._model.syncPointer({parent:t,x:e.x,y:e.y,z:e.z}):this._model.syncPointer(void 0)}),100),this._renderer.domElement.addEventListener("pointermove",this._onPointerMove.bind(this)),this._renderer.domElement.addEventListener("mouseup",(e=>{this._onClick.bind(this)(e)})),this._renderer.domElement.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation(),this._contextMenu.open(e)}));const e=new m.z(this._camera,this._renderer.domElement);e.target.set(this._scene.position.x,this._scene.position.y,this._scene.position.z),this._controls=e,this._controls.addEventListener("change",(()=>{this._updateAnnotation()})),this._controls.addEventListener("change",(0,g.P2)((()=>{var e;(null===(e=this._model.localState)||void 0===e?void 0:e.remoteUser)||this._model.syncCamera({position:this._camera.position.toArray([]),rotation:this._camera.rotation.toArray([]),up:this._camera.up.toArray([])},this.state.id)}),100))}},this.startAnimationLoop=()=>{this._requestID=window.requestAnimationFrame(this.startAnimationLoop),this._controls.update(),this._renderer.setRenderTarget(null),this._renderer.clearDepth(),this._renderer.render(this._scene,this._camera)},this.resizeCanvasToDisplaySize=()=>{null!==this.divRef.current&&(this._renderer.setSize(this.divRef.current.clientWidth,this.divRef.current.clientHeight,!1),"PerspectiveCamera"===this._camera.type?this._camera.aspect=this.divRef.current.clientWidth/this.divRef.current.clientHeight:(this._camera.left=this.divRef.current.clientWidth/-2,this._camera.right=this.divRef.current.clientWidth/2,this._camera.top=this.divRef.current.clientHeight/2,this._camera.bottom=this.divRef.current.clientHeight/-2),this._camera.updateProjectionMatrix())},this.generateScene=()=>{this.sceneSetup(),this.startAnimationLoop(),this.resizeCanvasToDisplaySize()},this.messageHandler=e=>{switch(e.action){case i.MainAction.DISPLAY_SHAPE:{const{result:t,postResult:o}=e.payload;if(this._saveMeta(t),this._shapeToMesh(t),Object.keys(t).length>0)if(this._firstRender){const e=this._model.sharedModel.outputs;Object.entries(e).forEach((([e,t])=>{this._objToMesh(e,t)})),this._firstRender=!1}else this._postWorkerId.forEach(((e,t)=>{e.postMessage({id:t,action:i.WorkerAction.POSTPROCESS,payload:o})}));break}case i.MainAction.INITIALIZED:{if(!this._model)return;const e=this._model.getContent();this._postMessage({action:i.WorkerAction.LOAD_FILE,payload:{content:e}})}}},this.postProcessWorkerHandler=e=>{e.action===i.MainAction.DISPLAY_POST&&e.payload.forEach((e=>{const{jcObject:t,postResult:o}=e;this._model.sharedModel.setOutput(t.name,o),this._objToMesh(t.name,o)}))},this._projectVector=e=>{const t=(new c.Pa4).copy(e),o=this._renderer.domElement;return t.project(this._camera),new c.FM8((.5+t.x/2)*o.width,(.5-t.y/2)*o.height)},this._saveMeta=e=>{this._model&&Object.entries(e).forEach((([e,t])=>{this._model.sharedModel.setShapeMeta(e,t.meta)}))},this._shapeToMesh=e=>{var t;null!==this._meshGroup&&this._scene.remove(this._meshGroup),null!==this._explodedViewLinesHelperGroup&&this._scene.remove(this._explodedViewLinesHelperGroup);const o=this._model.sharedModel.getOption("guidata"),s=this._selectedMeshes.map((e=>e.name));this._selectedMeshes=[],this._boundingGroup=new c.ZzF,this._meshGroup=new c.ZAu,Object.entries(e).forEach((([e,t])=>{const{faceList:n,edgeList:i,jcObject:a}=t,d=[],r=[],l=[];let h=0;if(0===n.length&&0===i.length)return;n.forEach((e=>{d.push(...e.vertexCoord),r.push(...e.normalCoord);for(let t=0;t<e.triIndexes.length;t+=3)l.push(e.triIndexes[t+0]+h,e.triIndexes[t+1]+h,e.triIndexes[t+2]+h);h+=e.vertexCoord.length/3}));let m=x,p=a.visible;if(o&&o[e]){const t=o[e];if(Object.prototype.hasOwnProperty.call(t,"color")){const e=t.color;m=new c.Ilk(e[0],e[1],e[2])}Object.prototype.hasOwnProperty.call(t,"visibility")&&(p=o[e].visibility)}const u=new c.xoR({color:m,side:c.ehD,wireframe:!1,flatShading:!1,shininess:0}),v=new c.u9r;v.setIndex(l),v.setAttribute("position",new c.a$l(d,3)),v.setAttribute("normal",new c.a$l(r,3)),v.computeBoundingBox(),d.length>0&&v.computeBoundsTree();const _=new c.Kj0(v,u);_.name=e,_.visible=p,p&&this._boundingGroup.expandByObject(_),s.includes(e)&&(this._selectedMeshes.push(_),_.material.color=O);const g=new c.nls({linewidth:5,color:S});i.forEach((e=>{const t=new c.a$l(e.vertexCoord,3),o=new c.u9r;o.setAttribute("position",t);const s=new c.x12(o,g);s.name="edge",_.add(s)})),this._meshGroup&&this._meshGroup.add(_)})),o&&(null===(t=this._model.sharedModel)||void 0===t||t.setOption("guidata",o)),this._updateRefLength(),this._setupExplodedView(),this._scene.add(this._meshGroup),this.setState((e=>Object.assign(Object.assign({},e),{loading:!1})))},this._postMessage=e=>{if(this._worker){const t=Object.assign(Object.assign({},e),{id:this.state.id});this._worker.postMessage(t)}},this._onSharedMetadataChanged=(e,t)=>{const o=Object.assign({},this.state.annotations);t.forEach(((e,t)=>{if(!t.startsWith("annotation"))return;const s=this._model.sharedModel.getMetadata(t);let n=!0;if(this.state.firstLoad&&(n=!1),!s||"add"!==e.action&&"update"!==e.action)"delete"===e.action&&delete o[t];else{const e=JSON.parse(s);e.open=n,o[t]=e}})),this.setState((e=>Object.assign(Object.assign({},e),{annotations:o,firstLoad:!1})))},this._onClientSharedStateChanged=(e,t)=>{var o,s,n,i,a;const d=null===(o=this._model.localState)||void 0===o?void 0:o.remoteUser;if(d){const e=t.get(d);if(!e)return;(null===(s=e.user)||void 0===s?void 0:s.username)!==(null===(n=this.state.remoteUser)||void 0===n?void 0:n.username)&&this.setState((t=>Object.assign(Object.assign({},t),{remoteUser:e.user}))),Array.isArray(e.selected.value)&&this._updateSelected(e.selected.value);const o=e.camera;if(null==o?void 0:o.value){const{position:e,rotation:t,up:s}=o.value;this._camera.position.set(e[0],e[1],e[2]),this._camera.rotation.set(t[0],t[1],t[2]),this._camera.up.set(s[0],s[1],s[2])}}else{if(null!==this.state.remoteUser){this.setState((e=>Object.assign(Object.assign({},e),{remoteUser:null})));const e=null===(a=null===(i=this._model.localState)||void 0===i?void 0:i.camera)||void 0===a?void 0:a.value;if(e){const t=e.position,o=e.rotation,s=e.up;this._camera.position.set(t[0],t[1],t[2]),this._camera.rotation.set(o[0],o[1],o[2]),this._camera.up.set(s[0],s[1],s[2])}}const e=this._model.localState;(null==e?void 0:e.selected)&&Array.isArray(e.selected.value)&&this._updateSelected(e.selected.value)}t.forEach(((e,t)=>{var o,s;const n=null===(o=e.pointer)||void 0===o?void 0:o.value;if(this._model.getClientId()===t)return;let i=this._collaboratorPointers[t];if(n){const o=null===(s=this._meshGroup)||void 0===s?void 0:s.getObjectByName(n.parent);if(!i){const s=this._createPointer(e.user);i=this._collaboratorPointers[t]={mesh:s,parent:o},this._scene.add(s)}if(i.mesh.visible=!0,this._explodedView.enabled){const e=this._computeExplodedState(o),t=e.vector.multiplyScalar(e.distance);i.mesh.position.copy(new c.Pa4(n.x+t.x,n.y+t.y,n.z+t.z))}else i.mesh.position.copy(new c.Pa4(n.x,n.y,n.z));i.parent=o}else this._collaboratorPointers[t]&&(this._collaboratorPointers[t].mesh.visible=!1)}))},this._handleThemeChange=()=>{const e="true"===document.body.getAttribute("data-jp-theme-light");x.set((0,g.pj)(y)),S.set((0,g.pj)(f)),O.set((0,g.pj)(C)),this.setState((t=>Object.assign(Object.assign({},t),{lightTheme:e})))},this._handleWindowResize=()=>{this.resizeCanvasToDisplaySize(),this._updateAnnotation()},this.divRef=l.createRef(),this._selectedMeshes=[],this._meshGroup=null,this._boundingGroup=new c.ZzF,this._explodedView={enabled:!1,factor:0},this._explodedViewLinesHelperGroup=null,this._cameraSettings={type:"Perspective"},this._raycaster=new c.iMs,this._requestID=null,this._refLength=null,this._pointer3D=null,this._postWorkerId=new Map,this._firstRender=!0,this._geometry=new c.u9r,this._geometry.setDrawRange(0,3e4),this.props.view.changed.connect(this._onViewChanged,this),this._model=this.props.jcadModel,this._pointer=new c.FM8,this._collaboratorPointers={},this._model.themeChanged.connect(this._handleThemeChange,this),this._model.sharedObjectsChanged.connect(this._onSharedObjectsChanged,this),this._model.sharedOptionsChanged.connect(this._onSharedOptionsChanged,this),this._model.clientStateChanged.connect(this._onClientSharedStateChanged,this),this._model.sharedMetadataChanged.connect(this._onSharedMetadataChanged,this),this._raycaster.params.Line&&(this._raycaster.params.Line.threshold=.1),this._worker=e.workerRegistry.getDefaultWorker();const t=this._worker.register({messageHandler:this.messageHandler.bind(this)});e.workerRegistry.getAllWorkers().forEach((e=>{const t=e.register({messageHandler:this.postProcessWorkerHandler.bind(this)});this._postWorkerId.set(t,e)}));const o="true"===document.body.getAttribute("data-jp-theme-light");this.state={id:t,lightTheme:o,loading:!0,annotations:{},firstLoad:!0}}componentDidMount(){window.addEventListener("resize",this._handleWindowResize),this.generateScene(),this.addContextMenu()}componentDidUpdate(e,t){this.resizeCanvasToDisplaySize()}componentWillUnmount(){window.cancelAnimationFrame(this._requestID),window.removeEventListener("resize",this._handleWindowResize),this.props.view.changed.disconnect(this._onViewChanged,this),this._controls.dispose(),this._model.themeChanged.disconnect(this._handleThemeChange,this),this._model.sharedOptionsChanged.disconnect(this._onSharedOptionsChanged,this),this._model.sharedObjectsChanged.disconnect(this._onSharedObjectsChanged,this),this._model.clientStateChanged.disconnect(this._onClientSharedStateChanged,this),this._model.sharedMetadataChanged.disconnect(this._onSharedMetadataChanged,this)}_pick(){var e;if(null===this._meshGroup||!this._meshGroup.children)return null;this._raycaster.setFromCamera(this._pointer,this._camera);const t=this._raycaster.intersectObjects(this._meshGroup.children);if(t.length>0)for(const o of t)if(o.object.visible&&(null===(e=o.object.parent)||void 0===e?void 0:e.visible))return{mesh:o.object,position:o.point};return null}_updateAnnotation(){Object.keys(this.state.annotations).forEach((e=>{var t,o;const s=document.getElementById(e);if(s){const n=null===(t=this._model.annotationModel)||void 0===t?void 0:t.getAnnotation(e);let i=new c.FM8;if(n){const e=null===(o=this._meshGroup)||void 0===o?void 0:o.getObjectByName(n.parent),t=new c.Pa4(n.position[0],n.position[1],n.position[2]);if(this._explodedView.enabled&&e){const o=this._computeExplodedState(e),s=o.vector.multiplyScalar(o.distance);t.add(s)}i=this._projectVector(t)}s.style.left=`${Math.round(i.x)}px`,s.style.top=`${Math.round(i.y)}px`}}))}_onPointerMove(e){const t=this._renderer.domElement.getBoundingClientRect();this._pointer.x=(e.clientX-t.left)/t.width*2-1,this._pointer.y=-(e.clientY-t.top)/t.height*2+1;const o=this._pick();if(!this._pointer3D&&this._model.localState&&o&&(this._pointer3D={parent:o.mesh,mesh:this._createPointer(this._model.localState.user)},this._scene.add(this._pointer3D.mesh)),o){if(!this._pointer3D)return void this._syncPointer(void 0,void 0);if(this._pointer3D.mesh.visible=!0,this._pointer3D.mesh.position.copy(o.position),this._pointer3D.parent=o.mesh,this._explodedView.enabled){const e=this._computeExplodedState(this._pointer3D.parent);o.position.add(e.vector.multiplyScalar(-e.distance))}this._syncPointer(o.position,o.mesh.name)}else this._pointer3D&&(this._pointer3D.mesh.visible=!1),this._syncPointer(void 0,void 0)}_onClick(e){const t=this._pick(),o=new Set(this._selectedMeshes.map((e=>e.name)));if(t){let s=t.mesh.name;if((s.startsWith("edge")||""===s)&&(s=t.mesh.parent.name),e.ctrlKey)o.has(s)?o.delete(s):o.add(s);else{const e=o.has(s);o.clear(),e||o.add(s)}const n=Array.from(o);this._updateSelected(n),this._model.syncSelectedObject(n,this.state.id)}}_updateRefLength(e=!1){if(this._meshGroup){if(e||null===this._refLength&&this._meshGroup.children.length){const e=new c.Pa4;this._boundingGroup.getSize(e),this._refLength=Math.max(e.x,e.y,e.z)/5||1,this._updatePointers(this._refLength),this._camera.lookAt(this._scene.position),this._camera.position.set(10*this._refLength,10*this._refLength,10*this._refLength),this._camera.far=200*this._refLength}this._meshGroup.children.length||(this._refLength=null)}}async _objToMesh(e,t){var o;const{binary:s,format:n,value:i}=t;let a;if("STL"===n){let e;if(s){const t=`data:application/octet-stream;base64,${i}`,o=await fetch(t);e=await o.arrayBuffer()}else e=i;a=(new p.j).parse(e)}if(!a)return;const d=new c.xoR({color:x,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),r=new c.Kj0(a,d),l=new c.Uk6(r.geometry),h=new c.nls({color:"black"}),m=new c.ejS(l,h);r.add(m),r.name=e,r.visible=!0,this._meshGroup&&(this._meshGroup.add(r),null===(o=this._boundingGroup)||void 0===o||o.expandByObject(r)),this._updateRefLength(!0)}_updatePointers(e){this._pointerGeometry=new c.xo$(e/10,32,32);for(const e in this._collaboratorPointers)this._collaboratorPointers[e].mesh.geometry=this._pointerGeometry}_createPointer(e){var t;let o=null;o=(null===(t=e.color)||void 0===t?void 0:t.startsWith("var"))?r.ZP(getComputedStyle(document.documentElement).getPropertyValue(e.color.slice(4,-1))):r.ZP(e.color);const s=new c.vBJ({color:o?new c.Ilk(o.r/255,o.g/255,o.b/255):"black"});return new c.Kj0(this._pointerGeometry,s)}_updateSelected(e){var t,o,s;for(const e of this._selectedMeshes){let o=x;const s=this._model.sharedModel.getOption("guidata");if(s&&s[e.name]&&s[e.name].color){const t=s[e.name].color;o=new c.Ilk(t[0],t[1],t[2])}(null===(t=null==e?void 0:e.material)||void 0===t?void 0:t.color)&&(e.material.color=o)}this._selectedMeshes=[];for(const t of e){const e=null===(o=this._meshGroup)||void 0===o?void 0:o.getObjectByName(t);e&&(this._selectedMeshes.push(e),(null===(s=null==e?void 0:e.material)||void 0===s?void 0:s.color)&&(e.material.color=O))}}async _onSharedObjectsChanged(e,t){t.objectChange&&(await this._worker.ready,this._postMessage({action:i.WorkerAction.LOAD_FILE,payload:{content:this._model.getContent()}}))}_onSharedOptionsChanged(e,t){var o,s;const n=e.getOption("guidata");if(n)for(const e in n){const t=null===(o=this._meshGroup)||void 0===o?void 0:o.getObjectByName(e);if(t){if(Object.prototype.hasOwnProperty.call(n[e],"visibility")){const o=null===(s=this._explodedViewLinesHelperGroup)||void 0===s?void 0:s.getObjectByName(e),i=n[e];i&&(t.visible=i.visibility,o&&(o.visible=i.visibility))}if(t.material.color)if("color"in n[e]){const o=n[e].color,s=new c.Ilk(o[0],o[1],o[2]);t.material.color=s}else t.material.color=x}}}_onViewChanged(e,t){var o;if("axes"===t.key){null===(o=this._sceneAxe)||void 0===o||o.removeFromParent();const e=t.newValue;"remove"!==t.type&&e&&e.visible&&(this._sceneAxe=new c.y8_(e.size),this._scene.add(this._sceneAxe))}if("explodedView"===t.key){const e=t.newValue;"remove"!==t.type&&e&&(this._explodedView=e,this._setupExplodedView())}if("cameraSettings"===t.key){const e=t.newValue;"remove"!==t.type&&e&&(this._cameraSettings=e,this._updateCamera())}}_setupExplodedView(){var e,t,o,s;if(this._explodedView.enabled){const o=new c.Pa4;this._boundingGroup.getCenter(o),null===(e=this._explodedViewLinesHelperGroup)||void 0===e||e.removeFromParent(),this._explodedViewLinesHelperGroup=new c.ZAu;for(const e of null===(t=this._meshGroup)||void 0===t?void 0:t.children){const t=this._computeExplodedState(e);e.position.set(0,0,0),e.translateOnAxis(t.vector,t.distance);const o=new c.nls({color:S,linewidth:2}),s=(new c.u9r).setFromPoints([t.oldGeometryCenter,t.newGeometryCenter]),n=new c.x12(s,o);n.name=e.name,n.visible=e.visible,this._explodedViewLinesHelperGroup.add(n)}this._scene.add(this._explodedViewLinesHelperGroup)}else{for(const e of null===(o=this._meshGroup)||void 0===o?void 0:o.children)e.position.set(0,0,0);null===(s=this._explodedViewLinesHelperGroup)||void 0===s||s.removeFromParent()}}_updateCamera(){var e,t;const o=(new c.Pa4).copy(this._camera.position),s=(new c.Pa4).copy(this._camera.up);if(this._camera.remove(this._cameraLight),this._scene.remove(this._camera),"Perspective"===this._cameraSettings.type)this._camera=new c.cPb(90,2,.1,1e3);else{const o=(null===(e=this.divRef.current)||void 0===e?void 0:e.clientWidth)||0,s=(null===(t=this.divRef.current)||void 0===t?void 0:t.clientHeight)||0;this._camera=new c.iKG(o/-2,o/2,s/2,s/-2)}this._camera.add(this._cameraLight),this._scene.add(this._camera),this._controls.object=this._camera,this._camera.position.copy(o),this._camera.up.copy(s)}_computeExplodedState(e){var t;const o=new c.Pa4;this._boundingGroup.getCenter(o);const s=new c.Pa4;null===(t=e.geometry.boundingBox)||void 0===t||t.getCenter(s);const n=new c.Pa4(s.x-o.x,s.y-o.y,s.z-o.z),i=n.length()*this._explodedView.factor;return n.normalize(),{oldGeometryCenter:s,newGeometryCenter:new c.Pa4(s.x+i*n.x,s.y+i*n.y,s.z+i*n.z),vector:n,distance:i}}render(){var e;return l.createElement("div",{className:"jcad-Mainview",style:{border:this.state.remoteUser?`solid 3px ${this.state.remoteUser.color}`:"unset"}},l.createElement("div",{className:"jpcad-Spinner",style:{display:this.state.loading?"flex":"none"}}," ",l.createElement("div",{className:"jpcad-SpinnerContent"})," "),(null===(e=this.state.remoteUser)||void 0===e?void 0:e.display_name)?l.createElement("div",{style:{position:"absolute",top:1,right:3,background:this.state.remoteUser.color}},`Following ${this.state.remoteUser.display_name}`):null,Object.entries(this.state.annotations).map((([e,t])=>{var o;if(!this._model.annotationModel)return null;const s=null===(o=this._meshGroup)||void 0===o?void 0:o.getObjectByName(t.parent),n=new c.Pa4(t.position[0],t.position[1],t.position[2]);if(this._explodedView.enabled&&s){const e=this._computeExplodedState(s),t=e.vector.multiplyScalar(e.distance);n.add(t)}const i=this._projectVector(n);return l.createElement("div",{key:e,id:e,style:{left:i.x,top:i.y},className:"jcad-Annotation-Wrapper"},l.createElement(w,{itemId:e,model:this._model.annotationModel,open:!1}))})),l.createElement("div",{ref:this.divRef,style:{width:"100%",height:"calc(100%)"}}))}}var P=o(61879),I=o(39791),E=o(53968);class A extends P.DocumentWidget{constructor(e){super(e),this.onResize=e=>{window.dispatchEvent(new Event("resize"))}}dispose(){this.content.dispose(),super.dispose()}}class T extends v.ReactWidget{constructor(e){super(),this.addClass("jp-jupytercad-panel"),this._jcadModel=e.model,this._workerRegistry=e.workerRegistry,this._view=new I.ObservableMap}get viewChanged(){return this._view.changed}dispose(){this.isDisposed||(E.Signal.clearData(this),super.dispose())}get axes(){return this._view.get("axes")}set axes(e){this._view.set("axes",e||null)}get explodedView(){return this._view.get("explodedView")}set explodedView(e){this._view.set("explodedView",e||null)}get cameraSettings(){return this._view.get("cameraSettings")}set cameraSettings(e){this._view.set("cameraSettings",e||null)}deleteAxes(){this._view.delete("axes")}render(){return l.createElement(M,{view:this._view,jcadModel:this._jcadModel,workerRegistry:this._workerRegistry})}}class k extends l.Component{constructor(e){super(e);const t=()=>{this.forceUpdate()};this._model=e.model,this._model.contextChanged.connect((async()=>{var o,s,n,i,a,d,r,l;await(null===(s=null===(o=this._model)||void 0===o?void 0:o.context)||void 0===s?void 0:s.ready),null===(a=null===(i=null===(n=this._model)||void 0===n?void 0:n.context)||void 0===i?void 0:i.model)||void 0===a||a.sharedMetadataChanged.disconnect(t),this._model=e.model,null===(l=null===(r=null===(d=this._model)||void 0===d?void 0:d.context)||void 0===r?void 0:r.model)||void 0===l||l.sharedMetadataChanged.connect(t),this.forceUpdate()}))}render(){var e;const t=null===(e=this._model)||void 0===e?void 0:e.getAnnotationIds();if(!t||!this._model)return l.createElement("div",null);const o=t.map((e=>l.createElement("div",null,l.createElement(j,{model:this._model,itemId:e}),l.createElement("hr",{className:"jpcad-Annotations-Separator"}))));return l.createElement("div",null,o)}}class L extends _.PanelWithToolbar{constructor(e){super({}),this.title.label="Annotations",this.addClass("jpcad-Annotations"),this._model=e.model,this._widget=_.ReactWidget.create(l.createElement(k,{model:this._model})),this.addWidget(this._widget)}}var R=o(67388);class B extends d.Widget{constructor(){super({node:D()}),this.title.changed.connect((e=>{this.node.textContent=this.title.label}))}}function D(){const e=document.createElement("h2");return e.textContent="-",e}var N=o(89927);const W=new _.LabIcon({name:"jupytercad:visibilityIcon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">\n    <path d="M0 0h24v24H0V0z" fill="none" />\n    <path class="jp-icon3" d="M12 6c3.79 0 7.17 2.13 8.82 5.5C19.17 14.87 15.79 17 12 17s-7.17-2.13-8.82-5.5C4.83 8.13 8.21 6 12 6m0-2C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4zm0 5c1.38 0 2.5 1.12 2.5 2.5S13.38 14 12 14s-2.5-1.12-2.5-2.5S10.62 9 12 9m0-2c-2.48 0-4.5 2.02-4.5 4.5S9.52 16 12 16s4.5-2.02 4.5-4.5S14.48 7 12 7z" fill="none" />\n</svg>\n'}),z=new _.LabIcon({name:"jupytercad:visibilityOffIcon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">\n    <path d="M0 0h24v24H0V0zm0 0h24v24H0V0zm0 0h24v24H0V0zm0 0h24v24H0V0z" fill="none" />\n    <path class="jp-icon3" d="M12 6c3.79 0 7.17 2.13 8.82 5.5-.59 1.22-1.42 2.27-2.41 3.12l1.41 1.41c1.39-1.23 2.49-2.77 3.18-4.53C21.27 7.11 17 4 12 4c-1.27 0-2.49.2-3.64.57l1.65 1.65C10.66 6.09 11.32 6 12 6zm-1.07 1.14L13 9.21c.57.25 1.03.71 1.28 1.28l2.07 2.07c.08-.34.14-.7.14-1.07C16.5 9.01 14.48 7 12 7c-.37 0-.72.05-1.07.14zM2.01 3.87l2.68 2.68C3.06 7.83 1.77 9.53 1 11.5 2.73 15.89 7 19 12 19c1.52 0 2.98-.29 4.32-.82l3.42 3.42 1.41-1.41L3.42 2.45 2.01 3.87zm7.5 7.5l2.61 2.61c-.04.01-.08.02-.12.02-1.38 0-2.5-1.12-2.5-2.5 0-.05.01-.08.01-.13zm-3.4-3.4l1.75 1.75c-.23.55-.36 1.15-.36 1.78 0 2.48 2.02 4.5 4.5 4.5.63 0 1.23-.13 1.77-.36l.98.98c-.88.24-1.8.38-2.75.38-3.79 0-7.17-2.13-8.82-5.5.7-1.43 1.72-2.61 2.93-3.53z" fill="none" />\n</svg>\n'}),V={labTheme:{text:{fontSize:"14px",fontFamily:"var(--jp-ui-font-family)",color:"var(--jp-ui-font-color1)",selectedColor:"var(--jp-ui-inverse-font-color1)",hoverColor:"var(--jp-ui-font-color2)"},nodes:{folder:{bgColor:"var(--jp-layout-color1)",selectedBgColor:"var(--jp-layout-color2)",hoverBgColor:"var(--jp-layout-color2)"},leaf:{bgColor:"var(--jp-layout-color1)",selectedBgColor:"var(--jp-layout-color2)",hoverBgColor:"var(--jp-layout-color2)"},icons:{size:"9px",folderColor:"var(--jp-inverse-layout-color3)",leafColor:"var(--jp-inverse-layout-color3)"}}}};class G extends _.PanelWithToolbar{constructor(e){super(e),this.title.label="Objects tree";const t=v.ReactWidget.create(l.createElement(F,{cpModel:e.controlPanelModel}));this.addWidget(t),this.addClass("jpcad-sidebar-treepanel")}}class F extends l.Component{constructor(e){var t,o;super(e),this.stateToTree=()=>this.state.jcadObject?this.state.jcadObject.map((e=>{var t;const o=e.name,s=[];return e.shape&&s.push({id:`${o}#shape#${e.shape}#${this.state.filePath}`,label:"Shape",parentId:o}),e.operators&&s.push({id:`${o}#operator#${this.state.filePath}`,label:"Operators",parentId:o}),{id:o,label:null!==(t=e.name)&&void 0!==t?t:`Object (#${o})`,parentId:null,items:s}})):[],this._handleThemeChange=()=>{const e="true"===document.body.getAttribute("data-jp-theme-light");this.setState((t=>Object.assign(Object.assign({},t),{lightTheme:e})))},this._sharedJcadModelChanged=(e,t)=>{t.objectChange&&this.setState((e=>{var t,o;return Object.assign(Object.assign({},e),{jcadObject:null===(t=this.props.cpModel.jcadModel)||void 0===t?void 0:t.getAllObject(),options:null===(o=this.props.cpModel.sharedModel)||void 0===o?void 0:o.options})}))},this._onClientSharedStateChanged=(e,t)=>{var o,s,n;const i=null===(o=this.props.cpModel.jcadModel)||void 0===o?void 0:o.localState;if(!i)return;let a=[];if(i.remoteUser){const e=t.get(i.remoteUser);(null===(s=null==e?void 0:e.selected)||void 0===s?void 0:s.value)&&(a=e.selected.value)}else(null===(n=i.selected)||void 0===n?void 0:n.value)&&(a=i.selected.value);const d=[...this.state.openNodes];for(const e of a)e&&-1===d.indexOf(e)&&d.push(e);this.setState((e=>Object.assign(Object.assign({},e),{openNodes:d,selectedNodes:a})))},this._onClientSharedOptionsChanged=(e,t)=>{this.setState((t=>Object.assign(Object.assign({},t),{options:e.options})))};const s="true"===document.body.getAttribute("data-jp-theme-light");this.state={filePath:this.props.cpModel.filePath,jcadObject:null===(t=this.props.cpModel.jcadModel)||void 0===t?void 0:t.getAllObject(),lightTheme:s,selectedNodes:[],clientId:null,id:(0,u.Z)(),openNodes:[]},null===(o=this.props.cpModel.jcadModel)||void 0===o||o.sharedObjectsChanged.connect(this._sharedJcadModelChanged),this.props.cpModel.documentChanged.connect(((e,t)=>{t?(this.props.cpModel.disconnect(this._sharedJcadModelChanged),this.props.cpModel.disconnect(this._handleThemeChange),this.props.cpModel.disconnect(this._onClientSharedStateChanged),t.context.model.sharedObjectsChanged.connect(this._sharedJcadModelChanged),t.context.model.themeChanged.connect(this._handleThemeChange),t.context.model.clientStateChanged.connect(this._onClientSharedStateChanged),t.context.model.sharedOptionsChanged.connect(this._onClientSharedOptionsChanged),this.setState((e=>{var o,s;return Object.assign(Object.assign({},e),{filePath:t.context.localPath,jcadObject:null===(o=this.props.cpModel.jcadModel)||void 0===o?void 0:o.getAllObject(),options:null===(s=this.props.cpModel.sharedModel)||void 0===s?void 0:s.options,clientId:t.context.model.getClientId()})}))):this.setState({filePath:void 0,jcadObject:void 0,jcadOption:void 0})}))}getObjectFromName(e){if(e&&this.state.jcadObject){const t=this.state.jcadObject.filter((t=>t.name===e));if(t.length>0)return t[0]}}render(){const{selectedNodes:e,openNodes:t,options:o}=this.state,s=this.stateToTree(),n=[];for(const t of e){const e=s.filter((e=>e.id===t));e.length>0&&e[0].items.length>0&&n.push(e[0].items[0].id)}return l.createElement("div",{className:"jpcad-treeview-wrapper"},l.createElement(N.v,{multiSelect:!0,nodes:s,openNodes:t,selectedNodes:n,messages:{noData:"No data"},theme:"labTheme",themes:V,onToggleSelectedNodes:e=>{var t,o;if(e!==n)if(e&&e.length>0){const o=[];for(const t of e){const e=t;e.includes("#")?o.push(e.split("#")[0]):o.push(e)}null===(t=this.props.cpModel.jcadModel)||void 0===t||t.syncSelectedObject(o,this.state.id)}else null===(o=this.props.cpModel.jcadModel)||void 0===o||o.syncSelectedObject([])},RenderNode:e=>{const t=this.getObjectFromName(e.node.parentId);let s=!0;return t&&(s=t.visible),t&&o&&o.guidata&&Object.prototype.hasOwnProperty.call(o.guidata,t.name)&&Object.prototype.hasOwnProperty.call(o.guidata[t.name],"visibility")&&(s=o.guidata[t.name].visibility),l.createElement("div",{className:"jpcad-control-panel-tree "+(e.selected?"selected":"")},l.createElement("div",{style:{paddingLeft:"5px",minHeight:"20px",display:"flex",alignItems:"center",justifyContent:"space-between",minWidth:0}},l.createElement("span",{style:{whiteSpace:"nowrap",textOverflow:"ellipsis",overflowX:"hidden"}},e.node.label),"leaf"===e.type?l.createElement("div",{style:{display:"flex"}},l.createElement(_.ToolbarButtonComponent,{className:"jp-ToolbarButtonComponent",onClick:()=>{var t,o;const n=e.node.parentId,i=(null===(t=this.props.cpModel.sharedModel)||void 0===t?void 0:t.getOption("guidata"))||{[n]:{}};i&&(i[n]?i[n].visibility=!s:i[n]={visibility:!s}),null===(o=this.props.cpModel.sharedModel)||void 0===o||o.setOption("guidata",i)},icon:s?W:z}),l.createElement(_.ToolbarButtonComponent,{className:"jp-ToolbarButtonComponent",onClick:()=>{var t,o;const s=e.node.parentId;null===(t=this.props.cpModel.jcadModel)||void 0===t||t.sharedModel.removeObjectByName(s),null===(o=this.props.cpModel.jcadModel)||void 0===o||o.syncSelectedObject([])},icon:_.closeIcon})):null))}}))}}class U extends _.SidePanel{constructor(e){super(),this.addClass("jpcad-sidepanel-widget"),this._model=e.model,this._annotationModel=e.annotationModel;const t=new B;this.header.addWidget(t);const o=new G({controlPanelModel:this._model});this.addWidget(o);const s=new L({model:this._annotationModel});this.addWidget(s),e.tracker.currentChanged.connect(((o,s)=>{var n;s?(t.title.label=s.context.localPath,this._annotationModel.context=(null===(n=e.tracker.currentWidget)||void 0===n?void 0:n.context)||void 0):(t.title.label="-",this._annotationModel.context=void 0)}))}dispose(){super.dispose()}}class H{constructor(e){this._tracker=e.tracker,this._documentChanged=this._tracker.currentChanged}get documentChanged(){return this._documentChanged}get filePath(){var e;return null===(e=this._tracker.currentWidget)||void 0===e?void 0:e.context.localPath}get jcadModel(){var e;return null===(e=this._tracker.currentWidget)||void 0===e?void 0:e.context.model}get sharedModel(){var e;return null===(e=this._tracker.currentWidget)||void 0===e?void 0:e.context.model.sharedModel}disconnect(e){this._tracker.forEach((t=>{t.context.model.sharedObjectsChanged.disconnect(e),t.context.model.sharedOptionsChanged.disconnect(e),t.context.model.sharedMetadataChanged.disconnect(e)})),this._tracker.forEach((t=>t.context.model.themeChanged.disconnect(e))),this._tracker.forEach((t=>t.context.model.clientStateChanged.disconnect(e)))}}class $ extends _.PanelWithToolbar{constructor(e){super(e),this.title.label="Objects Properties";const t=v.ReactWidget.create(l.createElement(J,{cpModel:e.controlPanelModel,formSchemaRegistry:e.formSchemaRegistry}));this.addWidget(t),this.addClass("jpcad-sidebar-propertiespanel")}}class J extends l.Component{constructor(e){var t,o;super(e),this.syncSelectedField=(e,t,o)=>{var s;let n=null;if(e){const t=e.split("_")[0];n=e.substring(t.length)}null===(s=this.props.cpModel.jcadModel)||void 0===s||s.syncSelectedPropField({parentType:o,id:n,value:t})},this._sharedJcadModelChanged=(e,t)=>{this.setState((e=>{var t,o;if(e.selectedObject){const o=null===(t=this.props.cpModel.jcadModel)||void 0===t?void 0:t.getAllObject();if(o){const t=(0,g.ro)(e.selectedObject,o);if(!t)return e;const s=t.parameters;return Object.assign(Object.assign({},e),{jcadObject:o,selectedObjectData:s})}return e}return Object.assign(Object.assign({},e),{jcadObject:null===(o=this.props.cpModel.jcadModel)||void 0===o?void 0:o.getAllObject()})}))},this._onClientSharedStateChanged=(e,t)=>{var o,s,n,i,a,d,r,l,c;const h=null===(s=null===(o=this.props.cpModel.jcadModel)||void 0===o?void 0:o.localState)||void 0===s?void 0:s.remoteUser,m=this.state.clientId;let p;if(h){p=t.get(h);const e=null===(n=null==p?void 0:p.selectedPropField)||void 0===n?void 0:n.id,o=null===(i=null==p?void 0:p.selectedPropField)||void 0===i?void 0:i.value;"panel"===(null===(a=null==p?void 0:p.selectedPropField)||void 0===a?void 0:a.parentType)&&(this._lastSelectedPropFieldId=(0,g.Dd)(`${this.state.filePath}::panel`,e,o,null===(d=null==p?void 0:p.user)||void 0===d?void 0:d.color,this._lastSelectedPropFieldId))}else{const e=m?t.get(m):null;this._lastSelectedPropFieldId&&((0,g.ef)(`${this.state.filePath}::panel`,this._lastSelectedPropFieldId,["border-color","box-shadow"]),this._lastSelectedPropFieldId=void 0),e&&(null===(r=e.selected)||void 0===r?void 0:r.emitter)&&e.selected.emitter!==this.state.id&&(null===(l=e.selected)||void 0===l?void 0:l.value)&&(p=e)}if(p){const e=""+p.selected.value;if(e!==this.state.selectedObject){if(0===e.length)return void this.setState((e=>Object.assign(Object.assign({},e),{schema:void 0,selectedObject:"",selectedObjectData:void 0})));const t=null===(c=this.props.cpModel.jcadModel)||void 0===c?void 0:c.getAllObject();if(t){let o;const s=(0,g.ro)(e,t);if(!s)return;s.shape&&(o=this._formSchema.get(s.shape));const n=s.parameters;this.setState((t=>Object.assign(Object.assign({},t),{selectedObjectData:n,selectedObject:e,schema:o})))}}}},this.state={filePath:this.props.cpModel.filePath,jcadObject:null===(t=this.props.cpModel.jcadModel)||void 0===t?void 0:t.getAllObject(),clientId:null,id:(0,u.Z)()},this._formSchema=e.formSchemaRegistry.getSchemas(),null===(o=this.props.cpModel.jcadModel)||void 0===o||o.sharedObjectsChanged.connect(this._sharedJcadModelChanged),this.props.cpModel.documentChanged.connect(((e,t)=>{t?(this.props.cpModel.disconnect(this._sharedJcadModelChanged),this.props.cpModel.disconnect(this._onClientSharedStateChanged),t.context.model.sharedObjectsChanged.connect(this._sharedJcadModelChanged),t.context.model.clientStateChanged.connect(this._onClientSharedStateChanged),this.setState((e=>{var o;return Object.assign(Object.assign({},e),{filePath:t.context.localPath,jcadObject:null===(o=this.props.cpModel.jcadModel)||void 0===o?void 0:o.getAllObject(),clientId:t.context.model.getClientId()})}))):this.setState({jcadOption:void 0,filePath:void 0,jcadObject:void 0,selectedObjectData:void 0,selectedObject:void 0,schema:void 0})}))}syncObjectProperties(e,t){var o;if(!this.state.jcadObject||!e)return;const s=null===(o=this.props.cpModel.jcadModel)||void 0===o?void 0:o.sharedModel,n=null==s?void 0:s.getObjectByName(e);s&&n&&s.updateObjectByName(e,"parameters",Object.assign(Object.assign({},n.parameters),t))}render(){return this.state.schema&&this.state.selectedObjectData?l.createElement(R.z,{parentType:"panel",filePath:`${this.state.filePath}::panel`,schema:this.state.schema,sourceData:this.state.selectedObjectData,syncData:e=>{this.syncObjectProperties(this.state.selectedObject,e)},syncSelectedField:this.syncSelectedField}):l.createElement("div",null)}}class Q extends _.SidePanel{constructor(e){super(),this.addClass("jpcad-sidepanel-widget"),this._model=e.model;const t=new B;this.header.addWidget(t);const o=new $({controlPanelModel:this._model,formSchemaRegistry:e.formSchemaRegistry});this.addWidget(o),this._model.documentChanged.connect(((e,s)=>{s?s.context.model.sharedModel.editable?(t.title.label=s.context.localPath,o.show()):(t.title.label=`${s.context.localPath} - Read Only`,o.hide()):t.title.label="-"}))}dispose(){super.dispose()}}var Z=o(40448),K=o(60565),Y=o(72195),q=o(35710),X=o(50757);class ee extends l.Component{constructor(e){super(e),this.selectUser=e=>{var t;let o;e.userId!==(null===(t=this.state.selectedUser)||void 0===t?void 0:t.userId)&&(o=e),this.setState((e=>Object.assign(Object.assign({},e),{selectedUser:o})),(()=>{this._model.setUserToFollow(null==o?void 0:o.userId)}))},this._model=e.model,this.state={usersList:[]}}componentDidMount(){this.setState((e=>Object.assign(Object.assign({},e),{usersList:this._model.users}))),this._model.userChanged.connect(((e,t)=>{this.setState((e=>Object.assign(Object.assign({},e),{usersList:t})))}))}createUserIcon(e){var t;let o;const{userId:s,userData:n}=e,i=s===(null===(t=this.state.selectedUser)||void 0===t?void 0:t.userId)?"selected":"";return o=n.avatar_url?l.createElement("div",{key:s,title:n.display_name,className:`lm-MenuBar-itemIcon jp-MenuBar-imageIcon ${i}`,onClick:()=>this.selectUser(e)},l.createElement("img",{src:n.avatar_url,alt:""})):l.createElement("div",{key:s,title:n.display_name,className:`lm-MenuBar-itemIcon jp-MenuBar-anonymousIcon ${i}`,style:{backgroundColor:n.color},onClick:()=>this.selectUser(e)},l.createElement("span",null,n.initials)),o}render(){return l.createElement("div",{className:"jpcad-toolbar-usertoolbar"},this.state.usersList.map((e=>{if(e.userId!==this._model.currentUserId)return this.createUserIcon(e)})))}}const te="jcad-Toolbar-Separator";class oe extends d.Widget{constructor(){super(),this.addClass(te)}}class se extends _.Toolbar{constructor(e){var t;super(e),this.addClass("jpcad-toolbar-widget"),e.commands&&(this.addItem("undo",new v.CommandToolbarButton({id:s.TQ.undo,label:"",icon:_.undoIcon,commands:e.commands})),this.addItem("redo",new v.CommandToolbarButton({id:s.TQ.redo,label:"",icon:_.redoIcon,commands:e.commands})),this.addItem("separator1",new oe),this.addItem("New Box",new v.CommandToolbarButton({id:s.TQ.newBox,label:"",commands:e.commands})),this.addItem("New Cylinder",new v.CommandToolbarButton({id:s.TQ.newCylinder,label:"",commands:e.commands})),this.addItem("New Sphere",new v.CommandToolbarButton({id:s.TQ.newSphere,label:"",commands:e.commands})),this.addItem("New Cone",new v.CommandToolbarButton({id:s.TQ.newCone,label:"",commands:e.commands})),this.addItem("New Torus",new v.CommandToolbarButton({id:s.TQ.newTorus,label:"",commands:e.commands})),this.addItem("separator2",new oe),this.addItem("Cut",new v.CommandToolbarButton({id:s.TQ.cut,label:"",commands:e.commands})),this.addItem("Union",new v.CommandToolbarButton({id:s.TQ.union,label:"",commands:e.commands})),this.addItem("Intersection",new v.CommandToolbarButton({id:s.TQ.intersection,label:"",commands:e.commands})),this.addItem("Extrusion",new v.CommandToolbarButton({id:s.TQ.extrusion,label:"",commands:e.commands})),this.addItem("separator3",new oe),this.addItem("New Sketch",new v.CommandToolbarButton({id:s.TQ.newSketch,label:"",commands:e.commands})),this.addItem("separator4",new oe),this.addItem("Axes Helper",new v.CommandToolbarButton({id:s.TQ.updateAxes,label:"",commands:e.commands})),this.addItem("Exploded View",new v.CommandToolbarButton({id:s.TQ.updateExplodedView,label:"",commands:e.commands})),this.addItem("Camera Settings",new v.CommandToolbarButton({id:s.TQ.updateCameraSettings,label:"",commands:e.commands})),this.addItem("separator5",new oe),(null!==(t=e.externalCommands)&&void 0!==t?t:[]).forEach((t=>{var o;this.addItem(t.name,new v.CommandToolbarButton({id:t.id,label:null!==(o=t.label)&&void 0!==o?o:"",commands:e.commands}))})),this.addItem("spacer",_.Toolbar.createSpacerItem()),this.addItem("users",_.ReactWidget.create(l.createElement(ee,{model:e.model}))))}}class ne{constructor(e){this._contextChanged=new E.Signal(this),this._updateSignal=new E.Signal(this),this.context=e.context}get updateSignal(){return this._updateSignal}get user(){return this._user}set context(e){var t;this._context=e;const o=null===(t=this._context)||void 0===t?void 0:t.model.sharedModel.awareness.getLocalState();this._user=null==o?void 0:o.user,this._contextChanged.emit(void 0)}get context(){return this._context}get contextChanged(){return this._contextChanged}update(){this._updateSignal.emit(null)}getAnnotation(e){var t;const o=null===(t=this._context)||void 0===t?void 0:t.model.sharedModel.getMetadata(e);if(o)return JSON.parse(o)}getAnnotationIds(){var e;const t=[];for(const o in null===(e=this._context)||void 0===e?void 0:e.model.sharedModel.metadata)o.startsWith("annotation")&&t.push(o);return t}addAnnotation(e,t){var o;null===(o=this._context)||void 0===o||o.model.sharedModel.setMetadata(`annotation_${e}`,JSON.stringify(t))}removeAnnotation(e){var t;null===(t=this._context)||void 0===t||t.model.removeMetadata(e)}addContent(e,t){var o;const s={value:t,user:this._user},n=this.getAnnotation(e);if(n){const t=Object.assign(Object.assign({},n),{contents:[...n.contents,s]});null===(o=this._context)||void 0===o||o.model.sharedModel.setMetadata(e,JSON.stringify(t))}}}}}]);