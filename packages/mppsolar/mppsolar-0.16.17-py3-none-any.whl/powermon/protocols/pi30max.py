import logging

from powermon.commands.result import ResultType
from powermon.protocols.pi30 import PI30
from powermon.commands.reading_definition import ResponseType
from powermon.commands.reading_definition import ReadingType
from powermon.commands.parameter import ParameterType
from powermon.commands.parameter import ParameterFormat

log = logging.getLogger("pi30max")

QUERY_COMMANDS = {
    "QSID": {
        "name": "QSID",
        "description": "Device Serial Number inquiry",
        "help": " -- queries the device serial number (length greater than 14)",
        "response_type": ResultType.INDEXED,
        #"response": [[0, "Serial Number", "bytes.decode:r[2:int(r[0:2])+2]", "", {"icon": "mdi:identifier"}]],
        "response": [[0, "Serial Number", ResponseType.BYTES, "", {"icon": "mdi:identifier"}]],
        "test_responses": [
            b"(1492932105105335005535\x94\x0e\r",
        ],
    },
    "QVFW3": {
        "name": "QVFW3",
        "description": "Remote CPU firmware version inquiry",
        "response_type": ResultType.INDEXED,
        "response": [[0, "Remote CPU firmware version", ResponseType.BYTES, "", {"icon": "mdi:identifier"}]],
        "test_responses": [
            b"(VERFW:00072.70\x53\xA7\r",
        ],
    },
    "VERFW": {
        "name": "VERFW",
        "description": "Bluetooth version inquiry",
        "response_type": ResultType.INDEXED,
        "response": [[0, "Bluetooth version", ResponseType.BYTES, "", {"icon": "mdi:identifier"}]],
        "test_responses": [
            b"(VERFW:00072.70\x53\xA7\r",
        ],
    },
    "QPIRI": {
        "name": "QPIRI",
        "description": "Current Settings inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [
                0,
                "AC Input Voltage",
                ResponseType.FLOAT,
                "V",
                {"icon": "mdi:transmission-tower-import", "device-class": "voltage"},
            ],
            [1, "AC Input Current", ResponseType.FLOAT, "A", {"icon": "mdi:current-ac", "device-class": "current"}],
            [
                2,
                "AC Output Voltage",
                ResponseType.FLOAT,
                "V",
                {"icon": "mdi:transmission-tower-export", "device-class": "voltage"},
            ],
            [3, "AC Output Frequency", ResponseType.FLOAT, "Hz", {"icon": "mdi:current-ac", "device-class": "frequency"}],
            [4, "AC Output Current", ResponseType.FLOAT, "A", {"icon": "mdi:current-ac", "device-class": "current"}],
            [5, "AC Output Apparent Power", ResponseType.INT, "VA", {"icon": "mdi:power-plug", "device-class": "apparent_power"}],
            [
                6,
                "AC Output Active Power",
                ResponseType.INT,
                "W",
                {"icon": "mdi:power-plug", "device-class": "power", "state_class": "measurement"},
            ],
            [7, "Battery Voltage", ResponseType.FLOAT, "V", {"icon": "mdi:battery-outline", "device-class": "voltage"}],
            [8, "Battery Recharge Voltage", ResponseType.FLOAT, "V", {"icon": "mdi:battery-outline", "device-class": "voltage"}],
            [9, "Battery Under Voltage", ResponseType.FLOAT, "V", {"icon": "mdi:battery-outline", "device-class": "voltage"}],
            [
                10,
                "Battery Bulk Charge Voltage",
                ResponseType.FLOAT,
                "V",
                {"icon": "mdi:battery-outline", "device-class": "voltage"},
            ],
            [
                11,
                "Battery Float Charge Voltage",
                ResponseType.FLOAT,
                "V",
                {"icon": "mdi:battery-outline", "device-class": "voltage"},
            ],
            [
                12,
                "Battery Type",
                ResponseType.OPTION,
                [
                    "AGM",
                    "Flooded",
                    "User",
                    "Pylontech",
                    "Shinheung",
                    "WECO",
                    "Soltaro",
                    "LIb-protocol compatible",
                    "3rd party Lithium",
                ],
            ],
            [13, "Max AC Charging Current", ResponseType.INT, "A", {"icon": "mdi:current-ac", "device-class": "current"}],
            [14, "Max Charging Current", ResponseType.INT, "A", {"icon": "mdi:current-ac", "device-class": "current"}],
            [15, "Input Voltage Range", ResponseType.OPTION, ["Appliance", "UPS"]],
            [
                16,
                "Output Source Priority",
                ResponseType.OPTION,
                [
                    "Utility Solar Battery",
                    "Solar Utility Battery",
                    "Solar Battery Utility",
                ],
            ],
            [
                17,
                "Charger Source Priority",
                ResponseType.OPTION,
                [
                    "Utility first",
                    "Solar first",
                    "Solar + Utility",
                    "Only solar charging permitted",
                ],
            ],
            [18, "Max Parallel Units", ResponseType.INT, "units"],
            [
                19,
                "Machine Type",
                ResponseType.OPTION,
                {"00": "Grid tie", "01": "Off Grid", "10": "Hybrid"},
            ],
            [20, "Topology", ResponseType.OPTION, ["transformerless", "transformer"]],
            [
                21,
                "Output Mode",
                ResponseType.OPTION,
                [
                    "single machine output",
                    "parallel output",
                    "Phase 1 of 3 Phase output",
                    "Phase 2 of 3 Phase output",
                    "Phase 3 of 3 Phase output",
                    "Phase 1 of 2 phase output",
                    "Phase 2 of 2 phase output (120°)",
                    "Phase 2 of 2 phase output (180°)",
                    "unknown output",
                ],
            ],
            [22, "Battery Redischarge Voltage", ResponseType.FLOAT, "V"],
            [
                23,
                "PV OK Condition",
                ResponseType.OPTION,
                [
                    "As long as one unit of inverters has connect PV, parallel system will consider PV OK",
                    "Only All of inverters have connect PV, parallel system will consider PV OK",
                ],
            ],
            [
                24,
                "PV Power Balance",
                ResponseType.OPTION,
                [
                    "PV input max current will be the max charged current",
                    "PV input max power will be the sum of the max charged power and loads power",
                ],
            ],
            [25, "Max charging time for CV stage", ResponseType.INT, "min"],
            [
                26,
                "Operation Logic",
                ResponseType.OPTION,
                ["Automatic mode", "On-line mode", "ECO mode"],
            ],
            [27, "Max discharging current", ResponseType.INT, "A", {"icon": "mdi:current-ac", "device-class": "current"}],
        ],
        "test_responses": [
            b"(230.0 21.7 230.0 50.0 21.7 5000 4000 48.0 46.0 42.0 56.4 54.0 0 10 010 1 0 0 6 01 0 0 54.0 0 1\x6F\x7E\r",
        ],
    },
    "QFLAG": {
        "name": "QFLAG",
        "description": "Flag Status inquiry",
        "help": " -- queries the enabled / disabled state of various Inverter settings (e.g. buzzer, overload, interrupt alarm)",
        "response_type": ResultType.INDEXED,
        "response": [
            [
                0,
                "Device Status",
                ResponseType.ENFLAGS,
                {
                    "a": {"name": "Buzzer", "state": "disabled"},
                    "b": {"name": "Overload Bypass", "state": "disabled"},
                    "d": {"name": "Solar Feed to Grid", "state": "disabled"},
                    "k": {"name": "LCD Reset to Default", "state": "disabled"},
                    "u": {"name": "Overload Restart", "state": "disabled"},
                    "v": {"name": "Over Temperature Restart", "state": "disabled"},
                    "x": {"name": "LCD Backlight", "state": "disabled"},
                    "y": {
                        "name": "Primary Source Interrupt Alarm",
                        "state": "disabled",
                    },
                    "z": {"name": "Record Fault Code", "state": "disabled"},
                },
            ]
        ],
        "test_responses": [
            b"(EakxyDbduvz\x8d\x73\r",
        ],
    },
    "QPIGS": {
        "name": "QPIGS",
        "description": "General Status Parameters inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [0, "AC Input Voltage", ResponseType.FLOAT, "V", {"icon": "mdi:transmission-tower-export", "device-class": "voltage"}],
            [1, "AC Input Frequency", ResponseType.FLOAT, "Hz", {"icon": "mdi:current-ac", "device-class": "frequency"}],
            [2, "AC Output Voltage", ResponseType.FLOAT, "V", {"icon": "mdi:power-plug", "device-class": "voltage"}],
            [3, "AC Output Frequency", ResponseType.FLOAT, "Hz", {"icon": "mdi:current-ac", "device-class": "frequency"}],
            [4, "AC Output Apparent Power", ResponseType.INT, "VA", {"icon": "mdi:power-plug", "device-class": "apparent_power"}],
            [5, "AC Output Active Power", ResponseType.INT, "W", {"icon": "mdi:power-plug", "device-class": "power", "state_class": "measurement"}],
            [6, "AC Output Load", ResponseType.INT, "%", {"icon": "mdi:brightness-percent"}],
            [7, "BUS Voltage", ResponseType.INT, "V", {"icon": "mdi:details", "device-class": "voltage"}],
            [8, "Battery Voltage", ResponseType.FLOAT, "V", {"icon": "mdi:battery-outline", "device-class": "voltage"}],
            [9, "Battery Charging Current", ResponseType.INT, "A", {"icon": "mdi:current-dc", "device-class": "current"}],
            [10, "Battery Capacity", ResponseType.INT, "%", {"device-class": "battery"}],
            [
                11,
                "Inverter Heat Sink Temperature",
                ResponseType.INT,
                "°C",
                {"icon": "mdi:details", "device-class": "temperature"},
            ],
            [12, "PV1 Input Current", ResponseType.FLOAT, "A", {"icon": "mdi:solar-power", "device-class": "current"}],
            [13, "PV1 Input Voltage", ResponseType.FLOAT, "V", {"icon": "mdi:solar-power", "device-class": "voltage"}],
            [
                14,
                "Battery Voltage from SCC",
                ResponseType.FLOAT,
                "V",
                {"icon": "mdi:battery-outline", "device-class": "voltage"},
            ],
            [
                15,
                "Battery Discharge Current",
                ResponseType.INT,
                "A",
                {"icon": "mdi:battery-negative", "device-class": "current"},
            ],
            [
                16,
                "Device Status",
                ResponseType.FLAGS,
                [
                    "Is SBU Priority Version Added",
                    "Is Configuration Changed",
                    "Is SCC Firmware Updated",
                    "Is Load On",
                    "Is Battery Voltage to Steady While Charging",
                    "Is Charging On",
                    "Is SCC Charging On",
                    "Is AC Charging On",
                ],
            ],
            [17, "Battery Voltage Offset for Fans On", ResponseType.INT, "10mV"],
            [18, "EEPROM Version", ResponseType.INT, ""],
            [
                19,
                "PV1 Charging Power",
                ResponseType.INT,
                "W",
                {"icon": "mdi:solar-power", "device-class": "power", "state_class": "measurement"},
            ],
            [
                20,
                "Device Status2",
                ResponseType.FLAGS,
                ["Is Charging to Float", "Is Switched On", "Is Dustproof Installed"],
            ],
            [21, "Solar Feed to Grid", ResponseType.OPTION, ["Disabled", "Enabled"]],
            [
                22,
                "Country",
                ResponseType.OPTION,
                {
                    "00": "India",
                    "01": "Germany",
                    "02": "South America",
                },
            ],
            [
                23,
                "Solar Feed to Grid Power",
                ResponseType.INT,
                "W",
                {"icon": "mdi:solar-power", "device-class": "power", "state_class": "measurement"},
            ],
        ],
        "test_responses": [
            b"(227.2 50.0 230.3 50.0 0829 0751 010 447 54.50 020 083 0054 02.7 323.6 00.00 00000 00010110 00 00 00879 010\xf1\x8c\r",
        ],
    },
    "QPIGS2": {
        "name": "QPIGS2",
        "description": "General Status Parameters inquiry 2",
        "response_type": ResultType.INDEXED,
        "response": [
            [0, "PV2 Input Current", ResponseType.FLOAT, "A", {"icon": "mdi:solar-power", "device-class": "current"}],
            [1, "PV2 Input Voltage", ResponseType.FLOAT, "V", {"icon": "mdi:solar-power", "device-class": "voltage"}],
            [
                2,
                "PV2 Charging Power",
                ResponseType.INT,
                "W",
                {"icon": "mdi:solar-power", "device-class": "power", "state_class": "measurement"},
            ],
        ],
        "test_responses": [
            b"(03.1 327.3 01026 \xc9\x8b\r",
        ],
    },
    "QPGS": {
        "name": "QPGS",
        "description": "Parallel Information inquiry",
        "help": " -- example: QPGS0 queries the values of various metrics from instance 0 of parallel setup Inverters",
        "response_type": ResultType.INDEXED,
        "response": [
            [0, "Parallel instance number", ResponseType.OPTION, ["Not valid", "valid"]],
            #[1, "Serial number", "bytes:r.decode()", "", {"icon": "mdi:identifier"}],
            [1, "Serial number", ResponseType.BYTES, "", {"icon": "mdi:identifier"}],
            [
                2,
                "Work mode",
                ResponseType.OPTION,
                {
                    "P": "Power On Mode",
                    "S": "Standby Mode",
                    "L": "Line Mode",
                    "B": "Battery Mode",
                    "F": "Fault Mode",
                    "H": "Power Saving Mode",
                    "D": "Shutdown Mode",
                },
            ],
            [
                3,
                "Fault code",
                ResponseType.OPTION,
                {
                    "00": "No fault",
                    "01": "Fan is locked",
                    "02": "Over temperature",
                    "03": "Battery voltage is too high",
                    "04": "Battery voltage is too low",
                    "05": "Output short circuited or Over temperature",
                    "06": "Output voltage is too high",
                    "07": "Over load time out",
                    "08": "Bus voltage is too high",
                    "09": "Bus soft start failed",
                    "10": "PV over current",
                    "11": "PV over voltage",
                    "12": "DC over current",
                    "13": "Battery discharge over current",
                    "51": "Over current inverter",
                    "52": "Bus voltage too low",
                    "53": "Inverter soft start failed",
                    "54": "Self-test failed",
                    "55": "Over DC voltage on output of inverter",
                    "56": "Battery connection is open",
                    "57": "Current sensor failed",
                    "58": "Output voltage is too low",
                    "60": "Power feedback protection",
                    "71": "Firmware version different",
                    "72": "Current sharing fault",
                    "80": "CAN communication failed",
                    "81": "Parallel host line lost",
                    "82": "Parallel synchronized signal lost",
                    "83": "Parallel battery voltage detect different",
                    "84": "AC input voltage or frequency detected different",
                    "85": "AC output current unbalanced",
                    "86": "AC output mode setting different",
                },
            ],
            [4, "Grid Voltage", ResponseType.FLOAT, "V", {"icon": "mdi:power-plug", "device-class": "voltage"}],
            [5, "Grid Frequency", ResponseType.FLOAT, "Hz", {"icon": "mdi:current-ac", "device-class": "frequency"}],
            [6, "AC Output Voltage", ResponseType.FLOAT, "V", {"icon": "mdi:power-plug", "device-class": "voltage"}],
            [7, "AC Output Frequency", ResponseType.FLOAT, "Hz", {"icon": "mdi:current-ac", "device-class": "frequency"}],
            [8, "AC Output Apparent Power", ResponseType.INT, "VA", {"icon": "mdi:power-plug", "device-class": "apparent_power"}],
            [
                9,
                "AC Output Active Power",
                ResponseType.INT,
                "W",
                {"icon": "mdi:power-plug", "device-class": "power", "state_class": "measurement"},
            ],
            [10, "Load Percentage", ResponseType.INT, "%", {"icon": "mdi:brightness-percent"}],
            [11, "Battery Voltage", ResponseType.FLOAT, "V", {"icon": "mdi:battery-outline", "device-class": "voltage"}],
            [12, "Battery Charging Current", ResponseType.INT, "A", {"icon": "mdi:current-dc", "device-class": "current"}],
            [13, "Battery Capacity", ResponseType.INT, "%", {"device-class": "battery"}],
            [14, "PV1 Input Voltage", ResponseType.FLOAT, "V", {"icon": "mdi:solar-power", "device-class": "voltage"}],
            [
                15,
                "Total Charging Current",
                ResponseType.INT,
                "A",
                {"icon": "mdi:brightness-percent", "device-class": "current"},
            ],
            [
                16,
                "Total AC Output Apparent Power",
                ResponseType.INT,
                "VA",
                {"icon": "mdi:power-plug", "device-class": "apparent_power"},
            ],
            [
                17,
                "Total Output Active Power",
                ResponseType.INT,
                "W",
                {"icon": "mdi:power-plug", "device-class": "power", "state_class": "measurement"},
            ],
            [
                18,
                "Total AC Output Percentage",
                ResponseType.INT,
                "%",
                {"icon": "mdi:brightness-percent"},
            ],
            [
                19,
                "Inverter Status",
                ResponseType.FLAGS,
                [
                    "Is SCC OK",
                    "Is AC Charging",
                    "Is SCC Charging",
                    "Is Battery Over Voltage",
                    "Is Battery Under Voltage",
                    "Is Line Lost",
                    "Is Load On",
                    "Is Configuration Changed",
                ],
            ],
            [
                20,
                "Output mode",
                ResponseType.OPTION,
                [
                    "single machine",
                    "parallel output",
                    "Phase 1 of 3 phase output",
                    "Phase 2 of 3 phase output",
                    "Phase 3 of 3 phase output",
                    "Phase 1 of 2 phase output",
                    "Phase 2 of 2 phase output (120°)",
                    "Phase 2 of 2 phase output (180°)",
                    "Unknown Output Mode",
                ],
            ],
            [
                21,
                "Charger source priority",
                ResponseType.OPTION,
                ["Utility first", "Solar first", "Solar + Utility", "Solar only"],
            ],
            [22, "Max Charger Current", ResponseType.INT, "A", {"device-class": "current"}],
            [23, "Max Charger Range", ResponseType.INT, "A", {"device-class": "current"}],
            [24, "Max AC Charger Current", ResponseType.INT, "A", {"device-class": "current"}],
            [25, "PV1 Input Current", ResponseType.INT, "A", {"icon": "mdi:solar-power", "device-class": "power"}],
            [
                26,
                "Battery Discharge Current",
                ResponseType.INT,
                "A",
                {"icon": "mdi:battery-negative", "device-class": "current"},
            ],
            [27, "PV2 Input Voltage", ResponseType.FLOAT, "V", {"icon": "mdi:solar-power", "device-class": "voltage"}],
            [28, "PV2 Input Current", ResponseType.INT, "A", {"icon": "mdi:solar-power", "device-class": "current"}],
        ],
        "test_responses": [
            b"(0 92932105105315 B 00 000.0 00.00 230.0 50.00 0989 0907 012 53.2 009 090 349.8 009 00989 00907 011 10100110 0 1 100 120 030 02 000 275.3 02i]\r",
        ],
        "regex": "QPGS(\\d+)$",
    },
    "QMOD": {
        "name": "QMOD",
        "description": "Mode inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [
                0,
                "Device Mode",
                ResponseType.OPTION,
                {
                    "P": "Power on",
                    "S": "Standby",
                    "L": "Line",
                    "B": "Battery",
                    "F": "Fault",
                    "H": "Power Saving",
                    "D": "Shutdown",
                },
            ]
        ],
        "test_responses": [
            b"(S\xe5\xd9\r",
            b"(B\xe7\xc9\r",
        ],
    },
    "QPIWS": {
        "name": "QPIWS",
        "description": "Warning status inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [
                0,
                "Warning",
                ResponseType.FLAGS,
                [
                    "PV loss warning",
                    "Inverter fault",
                    "Bus over fault",
                    "Bus under fault",
                    "Bus soft fail fault",
                    "Line fail warning",
                    "OPV short warning",
                    "Inverter voltage too low fault",
                    "Inverter voltage too high fault",
                    "Over temperature fault",
                    "Fan locked fault",
                    "Battery voltage to high fault",
                    "Battery low alarm warning",
                    "Reserved",
                    "Battery under shutdown warning",
                    "Battery derating warning",
                    "Overload fault",
                    "EEPROM fault",
                    "Inverter over current fault",
                    "Inverter soft fail fault",
                    "Self test fail fault",
                    "OP DC voltage over fault",
                    "Bat open fault",
                    "Current sensor fail fault",
                    "Battery short fault",
                    "Power limit warning",
                    "PV voltage high warning",
                    "MPPT overload fault",
                    "MPPT overload warning",
                    "Battery too low to charge warning",
                    "",
                    "Battery weak",
                    "Battery weak",
                    "Battery weak",
                    "",
                    "Battery equalisation warning",
                ],
            ]
        ],
        "test_responses": [
            b"(00000100000000001000000000000000\x56\xA6\r",
            b"(000000000000000000000000000000000000<\x8e\r",
        ],
    },
    "QDI": {
        "name": "QDI",
        "description": "Default Settings inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [0, "AC Output Voltage", ResponseType.FLOAT, "V"],
            [1, "AC Output Frequency", ResponseType.FLOAT, "Hz"],
            [2, "Max AC Charging Current", ResponseType.INT, "A"],
            [3, "Battery Under Voltage", ResponseType.FLOAT, "V"],
            [4, "Battery Float Charge Voltage", ResponseType.FLOAT, "V"],
            [5, "Battery Bulk Charge Voltage", ResponseType.FLOAT, "V"],
            [6, "Battery Recharge Voltage", ResponseType.FLOAT, "V"],
            [7, "Max Charging Current", ResponseType.INT, "A"],
            [8, "Input Voltage Range", ResponseType.OPTION, ["Appliance", "UPS"]],
            [
                9,
                "Output Source Priority",
                ResponseType.OPTION,
                ["Utility first", "Solar first", "SBU first"],
            ],
            [
                10,
                "Charger Source Priority",
                ResponseType.OPTION,
                [
                    "Utility first",
                    "Solar first",
                    "Solar + Utility",
                    "Only solar charging permitted",
                ],
            ],
            [
                11,
                "Battery Type",
                ResponseType.OPTION,
                [
                    "AGM",
                    "Flooded",
                    "User",
                    "TBD",
                    "Pylontech",
                    "WECO",
                    "Soltaro",
                    "LIb-protocol compatible",
                    "3rd party Lithium",
                ],
            ],
            [12, "Buzzer", ResponseType.OPTION, ["enabled", "disabled"]],
            [13, "Power saving", ResponseType.OPTION, ["disabled", "enabled"]],
            [14, "Overload restart", ResponseType.OPTION, ["disabled", "enabled"]],
            [15, "Over temperature restart", ResponseType.OPTION, ["disabled", "enabled"]],
            [16, "LCD Backlight", ResponseType.OPTION, ["disabled", "enabled"]],
            [17, "Primary source interrupt alarm", ResponseType.OPTION, ["disabled", "enabled"]],
            [18, "Record fault code", ResponseType.OPTION, ["disabled", "enabled"]],
            [19, "Overload bypass", ResponseType.OPTION, ["disabled", "enabled"]],
            [20, "LCD reset to default", ResponseType.OPTION, ["disabled", "enabled"]],
            [
                21,
                "Output mode",
                ResponseType.OPTION,
                [
                    "single machine",
                    "parallel output",
                    "Phase 1 of 3 phase output",
                    "Phase 2 of 3 phase output",
                    "Phase 3 of 3 phase output",
                    "Phase 1 of 2 phase output",
                    "Phase 2 of 2 phase output (120°)",
                    "Phase 2 of 2 phase output (180°)",
                    "Unknown Output Mode",
                ],
            ],
            [22, "Battery Redischarge Voltage", ResponseType.FLOAT, "V"],
            [
                23,
                "PV OK condition",
                ResponseType.OPTION,
                [
                    "As long as one unit of inverters has connect PV, parallel system will consider PV OK",
                    "Only All of inverters have connect PV, parallel system will consider PV OK",
                ],
            ],
            [
                24,
                "PV Power Balance",
                ResponseType.OPTION,
                [
                    "PV input max current will be the max charged current",
                    "PV input max power will be the sum of the max charged power and loads power",
                ],
            ],
            [25, "Max Charging Time at CV", ResponseType.INT, "min"],
            [26, "Max Discharging current", ResponseType.INT, "A"],
        ],
        "test_responses": [
            b"(230.0 50.0 0030 44.0 54.0 56.4 46.0 60 0 0 2 0 0 0 0 0 1 1 1 0 1 0 54.0 0 1 224\xeb\xbc\r",
        ],
    },
    "QOPPT": {
        "name": "QOPPT",
        "description": "Device Output Source Priority Time Order Inquiry",
        "response_type": ResultType.INDEXED,
        "response": [[0, "Output Source Priority 00 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [1, "Output Source Priority 01 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [2, "Output Source Priority 02 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [3, "Output Source Priority 03 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [4, "Output Source Priority 04 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [5, "Output Source Priority 05 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [6, "Output Source Priority 06 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [7, "Output Source Priority 07 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [8, "Output Source Priority 08 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [9, "Output Source Priority 09 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [10, "Output Source Priority 10 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [11, "Output Source Priority 11 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [12, "Output Source Priority 12 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [13, "Output Source Priority 13 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [14, "Output Source Priority 14 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [15, "Output Source Priority 15 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [16, "Output Source Priority 16 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [17, "Output Source Priority 17 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [18, "Output Source Priority 18 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [19, "Output Source Priority 19 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [20, "Output Source Priority 20 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [21, "Output Source Priority 21 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [22, "Output Source Priority 22 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [23, "Output Source Priority 23 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [24, "Device Output Source Priority", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [25, "Selection of Output Source Priority Order 1", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [26, "Selection of Output Source Priority Order 2", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     [27, "Selection of Output Source Priority Order 3", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"]],
                     ],
        "test_responses": [
            b"(2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 0 2 1>>\r",
        ],
    },
    "QCHPT": {
        "name": "QCHPT",
        "description": "Device Charger Source Priority Time Order Inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [0, "Charger Source Priority 00 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [1, "Charger Source Priority 01 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [2, "Charger Source Priority 02 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [3, "Charger Source Priority 03 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [4, "Charger Source Priority 04 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [5, "Charger Source Priority 05 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [6, "Charger Source Priority 06 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [7, "Charger Source Priority 07 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [8, "Charger Source Priority 08 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [9, "Charger Source Priority 09 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [10, "Charger Source Priority 10 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [11, "Charger Source Priority 11 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [12, "Charger Source Priority 12 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [13, "Charger Source Priority 13 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [14, "Charger Source Priority 14 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [15, "Charger Source Priority 15 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [16, "Charger Source Priority 16 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [17, "Charger Source Priority 17 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [18, "Charger Source Priority 18 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [19, "Charger Source Priority 19 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [20, "Charger Source Priority 20 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [21, "Charger Source Priority 21 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [22, "Charger Source Priority 22 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [23, "Charger Source Priority 23 hours", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [24, "Device Charger Source Priority", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [25, "Selection of Charger Source Priority Order 1", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [26, "Selection of Charger Source Priority Order 2", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
            [27, "Selection of Charger Source Priority Order 3", ResponseType.OPTION, ["undefined", "Solar first", "Solar + Utility", "Only Solar"],],
        ],
        "test_responses": [
            b"(3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 0 0 0\xd0\x8b\r",
        ],
    },
    "QT": {
        "name": "QT",
        "description": "Device Time Inquiry",
        "response_type": ResultType.INDEXED,
        "response": [[0, "Device Time", ResponseType.BYTES, ""]],
        "test_responses": [
            b"(20210726122606JF\r",
        ],
    },
    "QBEQI": {
        "name": "QBEQI",
        "description": "Battery Equalization Status Parameters Inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [0, "Equalization Enabled", ResponseType.OPTION, ["Disabled", "Enabled"]],
            [1, "Equalization Time", ResponseType.INT, "min"],
            [2, "Equalization Period", ResponseType.INT, "day"],
            [3, "Equalization Max Current", ResponseType.INT, "A"],
            [4, "Reserved1", ResponseType.BYTES, ""],
            [5, "Equalization Voltage", ResponseType.FLOAT, "V"],
            [6, "Reserved2", ResponseType.BYTES, ""],
            [7, "Equalization Over Time", ResponseType.INT, "min"],
            [8, "Equalization Active", ResponseType.OPTION, ["Inactive", "Active"]],
            [9, "Equalization Elasped Time", ResponseType.INT, "hour"],
        ],
        "test_responses": [
            b"(1 030 030 080 021 55.40 224 030 0 0234y?\r",
        ],
    },
    "QET": {
        "name": "QET",
        "description": "Total PV Generated Energy Inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [0,
                "Total PV Generated Energy", ResponseType.INT,
                "Wh",
                {"icon": "mdi:solar-power", "device-class": "energy", "state_class": "total"},
             ]
        ],
        "test_responses": [
            b"(00238800!J\r",
        ],
    },
    "QEY": {
        "name": "QEY",
        "description": "Yearly PV Generated Energy Inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [0,
                "PV Generated Energy for Year", ResponseType.INT, "Wh",
                {"icon": "mdi:counter", "device-class": "energy", "state_class": "total"},
             ],
            [1, "Year", ResponseType.INFO+":cn[3:]", ""],
        ],
        "test_responses": [
            b"(00238800!J\r",
        ],
        "regex": "QEY(\\d\\d\\d\\d)$",
    },
    "QEM": {
        "name": "QEM",
        "description": "Monthly PV Generated Energy Inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [0, "PV Generated Energy for Month", ResponseType.INT, "Wh", {"icon": "mdi:solar-power", "device-class": "energy", "state_class": "total"},],
            [1, "Year", ResponseType.INFO+":cn[3:7]", ""],
            [2, "Month", ResponseType.INFO+":calendar.month_name[int(cn[7:])]", ""],
        ],
        "test_responses": [
            b"(00238800!J\r",
        ],
        "regex": "QEM(\\d\\d\\d\\d\\d\\d)$",
    },
    "QED": {
        "name": "QED",
        "description": "Daily PV Generated Energy Inquiry",
        "help": " -- display daily generated energy, format is QEDyyyymmdd",
        "result_type": ResultType.INDEXED,
        "reading_definitions": [
            {"index":0, "description":"PV Generated Energy for Day", "reading_type":ReadingType.WATT_HOURS, "response_type":ResponseType.INT, "icon": "mdi:solar-power", "device-class": "energy", "state_class": "total"},
        ],
        "parameters": [
            {"name":"date", "description":"Date for query", "parameter_type":ParameterType.DATE, "parameter_format":ParameterFormat.YYYYMMDD}
        ],
        "test_responses": [
            b"(00238800!J\r",
        ],
        "regex": "QED(\\d\\d\\d\\d\\d\\d\\d\\d)$", 
    },
    "QLT": {
        "name": "QLT",
        "description": "Total Output Load Energy Inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [0, "Total Output Load Energy", ResponseType.INT, "Wh", {"icon": "mdi:counter", "device-class": "energy", "state_class": "total"},]
        ],
        "test_responses": [
            b"(00238800!J\r",
        ],
    },
    "QLY": {
        "name": "QLY",
        "description": "Yearly Output Load Energy Inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [0, "Output Load Energy for Year", ResponseType.INT, "Wh", {"icon": "mdi:counter", "device-class": "energy", "state_class": "total"},],
            [1, "Year", ResponseType.INFO+":cn[3:]", ""],
        ],
        "test_responses": [
            b"(00238800!J\r",
        ],
        "regex": "QLY(\\d\\d\\d\\d)$",
    },
    "QLM": {
        "name": "QLM",
        "description": "Monthly Output Load Energy Inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [0, "Output Load Energy for Month", ResponseType.INT, "Wh", {"icon": "mdi:counter", "device-class": "energy", "state_class": "total"},],
            [1, "Year", ResponseType.INFO+":cn[3:7]", ""],
            [2, "Month", ResponseType.INFO+":calendar.month_name[int(cn[7:])]", ""],
        ],
        "test_responses": [
            b"(00238800!J\r",
        ],
        "regex": "QLM(\\d\\d\\d\\d\\d\\d)$",
    },
    "QLD": {
        "name": "QLD",
        "description": "Daily Output Load Energy Inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [0, "Output Load Energy for Day", ResponseType.INT, "Wh", {"icon": "mdi:counter", "device-class": "energy", "state_class": "total"},],
            [1, "Year", ResponseType.INFO+":cn[3:7]", ""],
            [2, "Month", ResponseType.INFO+":calendar.month_name[int(cn[7:9])]", ""],
            [3, "Day", ResponseType.INFO+":cn[9:]", ""],
        ],
        "test_responses": [
            b"(00238800!J\r",
        ],
        "regex": "QLD(\\d\\d\\d\\d\\d\\d\\d\\d)$",
    },
    "QLED": {
        "name": "QLED",
        "description": "LED Status Parameters Inquiry",
        "response_type": ResultType.INDEXED,
        "response": [
            [0, "LED Enabled", ResponseType.OPTION, ["Disabled", "Enabled"]],
            [1, "LED Speed", ResponseType.OPTION, ["Low", "Medium", "Fast"]],
            [2, "LED Effect", ResponseType.OPTION, ["Breathing", "Unknown", "Solid", "Right Scrolling"],],
            [3, "LED Brightness", ResponseType.INT, ""],
            [4, "LED Number of Colors", ResponseType.INT, ""],
            [5, "RGB", ResponseType.BYTES, ""],
        ],
        "test_responses": [
            b"(1 1 2 5 3 148000211255255255000255255\xdaj\r",
        ],
    },
}

SETTER_COMMANDS = {
    "PLEDE": {
        "name": "PLEDE",
        "description": "Enable/disable LED function",
        "help": " -- examples: PLEDE0 (disable LED), PLEDE1 (enable LED)",
        "response_type": ResultType.ACK,
        "response": [[0, "Command execution", ResponseType.ACK, {"NAK": "Failed", "ACK": "Successful"}]],
        "test_responses": [
            b"(NAK\x73\x73\r",
            b"(ACK\x39\x20\r",
        ],
        "regex": "PLEDE([01])$",
    },
    "PLEDS": {
        "name": "PLEDS",
        "description": "Set LED speed",
        "help": " -- examples: PLEDS0 (set LED speed low), PLEDS1 (set LED speed medium), PLEDS2 (set LED speed high)",
        "response_type": ResultType.ACK,
        "response": [[0, "Command execution", ResponseType.ACK, {"NAK": "Failed", "ACK": "Successful"}]],
        "test_responses": [
            b"(NAK\x73\x73\r",
            b"(ACK\x39\x20\r",
        ],
        "regex": "PLEDS([012])$",
    },
    "PLEDM": {
        "name": "PLEDM",
        "description": "Set LED effect",
        "help": " -- examples: PLEDM0 (set LED effect breathing), PLEDM2 (set LED effect solid), PLEDM3 (set LED right scrolling)",
        "response_type": ResultType.ACK,
        "response": [[0, "Command execution", ResponseType.ACK, {"NAK": "Failed", "ACK": "Successful"}]],
        "test_responses": [
            b"(NAK\x73\x73\r",
            b"(ACK\x39\x20\r",
        ],
        "regex": "PLEDM([0123])$",
    },
    "PLEDB": {
        "name": "PLEDB",
        "description": "Set LED brightness",
        "help": " -- examples: PLEDB1 (set LED brightness low), PLEDB5 (set LED brightness normal), PLEDB9 (set LED brightness high)",
        "response_type": ResultType.ACK,
        "response": [[0, "Command execution", ResponseType.ACK, {"NAK": "Failed", "ACK": "Successful"}]],
        "test_responses": [
            b"(ACK\x39\x20\r",
            b"(NAK\x73\x73\r",
        ],
        "regex": "PLEDB([123456789])$",
    },
    "PLEDT": {
        "name": "PLEDT",
        "description": "Set LED total number of colors",
        "help": " -- examples: PLEDT2 (set 2 LED colors), PLEDT3 (set 3 LED colors)",
        "response_type": ResultType.ACK,
        "response": [[0, "Command execution", ResponseType.ACK, {"NAK": "Failed", "ACK": "Successful"}]],
        "test_responses": [
            b"(ACK\x39\x20\r",
            b"(NAK\x73\x73\r",
        ],
        "regex": "PLEDT([123])$",
    },
    "PLEDC": {
        "name": "PLEDC",
        "description": "Set LED color",
        "help": " -- examples: PLEDCnRRRGGGBBB (n: 1 line mode, 2 AVR mode, 3 battery mode)",
        "response_type": ResultType.ACK,
        "response": [[0, "Command execution", ResponseType.ACK, {"NAK": "Failed", "ACK": "Successful"}]],
        "test_responses": [
            b"(ACK\x39\x20\r",
            b"(NAK\x73\x73\r",
        ],
        "regex": "PLEDC(\\d\\d\\d\\d\\d\\d\\d\\d\\d\\d)$",
    },
}

COMMANDS_TO_REMOVE = ["QVFW2"]


class pi30max(PI30):
    def __str__(self):
        return "PI30 protocol handler for LV6048MAX and similar inverters"

    def __init__(self, *args, **kwargs) -> None:
        super().__init__()
        self._protocol_id = b"PI30MAX"
        # Add pi30max specific commands to pi30 commands
        super().add_command_definitions(QUERY_COMMANDS)
        # Add pi30max specific setter commands
        super().add_command_definitions(SETTER_COMMANDS)
        # remove and unwanted pi30 commands
        for item in COMMANDS_TO_REMOVE:
            self.command_definitions.pop(item, None)
        self.STATUS_COMMANDS = ["QPIGS", "QPIGS2"]
        self.SETTINGS_COMMANDS = ["QPIRI", "QFLAG"]
        self.DEFAULT_COMMAND = "QPI"
        self.check_definitions_count()
